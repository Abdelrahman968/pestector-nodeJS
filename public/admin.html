<!DOCTYPE html>
<html lang="en" x-data="{ darkMode: false }" :class="{ 'dark': darkMode }">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Pestector</title>
    <!-- Tailwind CSS v2.2.19 -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Heroicons (using CDN for simplicity) -->
    <script src="https://unpkg.com/@heroicons/vue@2.0.10/dist/heroicons.js"></script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Dark Mode */
        .dark .bg-gray-800 {
            background-color: #1f2937;
        }

        .dark .text-white {
            color: #e5e7eb;
        }

        .dark .bg-white {
            background-color: #374151;
        }

        .dark .text-gray-900 {
            color: #d1d5db;
        }

        .dark .bg-gray-100 {
            background-color: #111827;
        }

        .dark .bg-gray-50 {
            background-color: #4b5563;
        }

        .dark .text-gray-700 {
            color: #9ca3af;
        }

        .dark .bg-red-100 {
            background-color: #991b1b;
        }

        .dark .bg-green-100 {
            background-color: #166534;
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
    <!-- Alpine.js -->
    <script src="//unpkg.com/alpinejs" defer></script>
</head>

<body class="bg-gray-100 font-sans" x-data="adminApp()">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside x-data="{ open: true }" class="bg-gray-800 text-white flex flex-col transition-all duration-300"
            :class="{ 'w-64': open, 'w-16': !open }">
            <div class="p-4 flex justify-between items-center border-b border-gray-700">
                <span x-show="open" class="text-xl font-bold">Pestector Admin</span>
                <button @click="open = !open" class="text-white focus:outline-none">
                    <svg x-show="open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                    <svg x-show="!open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <a href="#dashboard" @click="setActiveSection('dashboard')"
                    :class="{'bg-gray-700': activeSection === 'dashboard'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Dashboard'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    <span x-show="open">Dashboard</span>
                </a>
                <a href="#users" @click="setActiveSection('users')" :class="{'bg-gray-700': activeSection === 'users'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Users'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    <span x-show="open">Users</span>
                </a>
                <a href="#subscriptions" @click="setActiveSection('subscriptions')"
                    :class="{'bg-gray-700': activeSection === 'subscriptions'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Subscriptions'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <span x-show="open">Subscriptions</span>
                </a>
                <a href="#history" @click="setActiveSection('history')"
                    :class="{'bg-gray-700': activeSection === 'history'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Scan History'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span x-show="open">Scan History</span>
                </a>
                <a href="#guests" @click="setActiveSection('guests')"
                    :class="{'bg-gray-700': activeSection === 'guests'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Guests'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <span x-show="open">Guests</span>
                </a>
                <a href="#contacts" @click="setActiveSection('contacts')"
                    :class="{'bg-gray-700': activeSection === 'contacts'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Contacts'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span x-show="open">Contacts</span>
                </a>
                <a href="#notifications" @click="setActiveSection('notifications')"
                    :class="{'bg-gray-700': activeSection === 'notifications'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Notifications'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                        </path>
                    </svg>
                    <span x-show="open">Notifications</span>
                </a>
                <a href="#analytics" @click="setActiveSection('analytics')"
                    :class="{'bg-gray-700': activeSection === 'analytics'}"
                    class="flex items-center px-4 py-2 rounded hover:bg-gray-700" :title="open ? '' : 'Analytics'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                    <span x-show="open">Analytics</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button @click="darkMode = !darkMode"
                    class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded mb-2 flex items-center justify-center"
                    :title="open ? '' : 'Toggle Dark Mode'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                        </path>
                    </svg>
                    <span x-show="open">Toggle Dark Mode</span>
                </button>
                <button @click="logout()"
                    class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded flex items-center justify-center"
                    :title="open ? '' : 'Logout'">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    <span x-show="open">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-6">
            <!-- Loading Indicator -->
            <div x-show="loading" class="fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center z-50">
                <div class="loader"></div>
            </div>

            <!-- Error Message -->
            <div x-show="errorMessage" x-cloak
                class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" x-text="errorMessage"></span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" @click="errorMessage = ''">
                    <svg class="fill-current h-6 w-6 text-red-500" viewBox="0 0 20 20">
                        <path
                            d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.03a1.2 1.2 0 1 1-1.697-1.697l3.03-2.651-3.03-2.651a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697l-3.03 2.651 3.03 2.651a1.2 1.2 0 0 1 0 1.697z" />
                    </svg>
                </span>
            </div>

            <!-- Success Message -->
            <div x-show="successMessage" x-cloak
                class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4"
                role="alert">
                <strong class="font-bold">Success!</strong>
                <span class="block sm:inline" x-text="successMessage"></span>
                <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" @click="successMessage = ''">
                    <svg class="fill-current h-6 w-6 text-green-500" viewBox="0 0 20 20">
                        <path
                            d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.03a1.2 1.2 0 1 1-1.697-1.697l3.03-2.651-3.03-2.651a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697l-3.03 2.651 3.03 2.651a1.2 1.2 0 0 1 0 1.697z" />
                    </svg>
                </span>
            </div>

            <!-- Dashboard Section -->
            <section x-show="activeSection === 'dashboard'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    Dashboard
                </h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded shadow flex items-center">
                        <svg class="w-8 h-8 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">Total Users</h3>
                            <p class="text-3xl font-bold" x-text="stats.user_count ?? 'Loading...'"></p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded shadow flex items-center">
                        <svg class="w-8 h-8 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">Total Guests</h3>
                            <p class="text-3xl font-bold" x-text="stats.guest_count ?? 'Loading...'"></p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded shadow flex items-center">
                        <svg class="w-8 h-8 text-purple-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">Total Scans</h3>
                            <p class="text-3xl font-bold" x-text="stats.history_count ?? 'Loading...'"></p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded shadow flex items-center">
                        <svg class="w-8 h-8 text-yellow-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">Subscriptions</h3>
                            <p class="text-sm">Pending: <span x-text="pendingSubsCount">0</span></p>
                            <p class="text-sm">Active: <span x-text="activeSubsCount">0</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- User Management Section -->
            <section x-show="activeSection === 'users'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    User Management
                </h1>
                <div class="mb-4 flex space-x-2 flex-wrap gap-2">
                    <input type="text" x-model="userSearchTerm" @input.debounce.500ms="fetchUsers(1)"
                        placeholder="Search users..." class="p-2 border rounded w-full md:w-1/3">
                    <button @click="bulkDelete('users', selectedUsers)" :disabled="!selectedUsers.length"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:opacity-50 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        Delete Selected
                    </button>
                    <a href="/api/admin/users/export" download
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Export CSV
                    </a>
                </div>
                <div class="bg-white shadow rounded overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox"
                                        @change="toggleSelectAll('users', $event.target.checked)"></th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Username</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Email</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Role</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Plan</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Joined</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-if="users.length === 0 && !loading">
                                <tr>
                                    <td colspan="7" class="text-center py-4">No users found.</td>
                                </tr>
                            </template>
                            <template x-for="user in users" :key="user._id">
                                <tr>
                                    <td class="px-6 py-4"><input type="checkbox" :value="user._id"
                                            x-model="selectedUsers"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                        x-text="user.username"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="user.email">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="user.role">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="user.subscription?.currentPlan || 'free'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDate(user.createdAt)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button @click="viewUserDetails(user._id)"
                                            class="text-indigo-600 hover:text-indigo-900">View</button>
                                        <button @click="editUser(user)"
                                            class="text-blue-600 hover:text-blue-900">Edit</button>
                                        <button @click="confirmDelete('user', user._id, user.username)"
                                            class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="userPagination.pages > 1" class="mt-4 flex justify-between items-center">
                    <span class="text-sm text-gray-700">
                        Page <span x-text="userPagination.page"></span> of <span x-text="userPagination.pages"></span>
                        (<span x-text="userPagination.total"></span> users)
                    </span>
                    <div>
                        <button @click="fetchUsers(userPagination.page - 1)" :disabled="userPagination.page <= 1"
                            class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Previous</button>
                        <button @click="fetchUsers(userPagination.page + 1)"
                            :disabled="userPagination.page >= userPagination.pages"
                            class="ml-2 px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Next</button>
                    </div>
                </div>
            </section>

            <!-- Subscription Management Section -->
            <section x-show="activeSection === 'subscriptions'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Subscription Management
                </h1>
                <div class="mb-4 flex space-x-2">
                    <button @click="bulkDelete('subscriptions', selectedSubscriptions)"
                        :disabled="!selectedSubscriptions.length"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:opacity-50 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        Delete Selected
                    </button>
                </div>
                <div class="bg-white shadow rounded overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox"
                                        @change="toggleSelectAll('subscriptions', $event.target.checked)"></th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    User</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Plan</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Start Date</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    End Date</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-if="subscriptions.length === 0 && !loading">
                                <tr>
                                    <td colspan="7" class="text-center py-4">No subscriptions found.</td>
                                </tr>
                            </template>
                            <template x-for="sub in subscriptions" :key="sub._id">
                                <tr>
                                    <td class="px-6 py-4"><input type="checkbox" :value="sub._id"
                                            x-model="selectedSubscriptions"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                        x-text="sub.userId?.username || sub.userId?.email || 'N/A'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="sub.plan">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <span x-text="sub.status"
                                            :class="{'bg-green-100 text-green-800': sub.status === 'active', 'bg-yellow-100 text-yellow-800': sub.status === 'pending', 'bg-red-100 text-red-800': ['canceled', 'expired'].includes(sub.status), 'bg-gray-100 text-gray-800': sub.status === 'rejected'}"
                                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDate(sub.startDate)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDate(sub.endDate)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <template x-if="sub.status === 'pending'">
                                            <button @click="processSubscription(sub._id, 'approve')"
                                                class="text-green-600 hover:text-green-900">Approve</button>
                                            <button @click="processSubscription(sub._id, 'reject')"
                                                class="text-yellow-600 hover:text-yellow-900">Reject</button>
                                        </template>
                                        <template x-if="sub.status === 'active'">
                                            <button @click="expireSubscription(sub._id)"
                                                class="text-orange-600 hover:text-orange-900">Expire</button>
                                        </template>
                                        <button @click="confirmDelete('subscription', sub._id)"
                                            class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Scan History Section -->
            <section x-show="activeSection === 'history'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Scan History (All Users)
                </h1>
                <div class="mb-4 flex space-x-2">
                    <input type="text" x-model="historySearchTerm" @input.debounce.500ms="fetchHistory(1)"
                        placeholder="Search history (filename, plant...)" class="p-2 border rounded w-full md:w-1/3">
                    <button @click="bulkDelete('history', selectedHistory)" :disabled="!selectedHistory.length"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:opacity-50 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        Delete Selected
                    </button>
                </div>
                <div class="bg-white shadow rounded overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox"
                                        @change="toggleSelectAll('history', $event.target.checked)"></th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    User</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Image</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Plant</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Condition</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Timestamp</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-if="history.length === 0 && !loading">
                                <tr>
                                    <td colspan="7" class="text-center py-4">No history found.</td>
                                </tr>
                            </template>
                            <template x-for="item in history" :key="item._id">
                                <tr>
                                    <td class="px-6 py-4"><input type="checkbox" :value="item._id"
                                            x-model="selectedHistory"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                        x-text="item.userId?.username || item.userId?.email || item.guestId || 'N/A'">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><img
                                            :src="item.imageUrl" alt="Scan" class="h-10 w-10 object-cover rounded"
                                            loading="lazy"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="item.classification?.prediction?.plant || 'N/A'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="item.classification?.prediction?.condition || 'N/A'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDateTime(item.timestamp)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button @click="confirmDelete('history', item._id)"
                                            class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="historyPagination.pages > 1" class="mt-4 flex justify-between items-center">
                    <span class="text-sm text-gray-700">Page <span x-text="historyPagination.page"></span> of <span
                            x-text="historyPagination.pages"></span> (<span x-text="historyPagination.total"></span>
                        items)</span>
                    <div>
                        <button @click="fetchHistory(historyPagination.page - 1)"
                            :disabled="historyPagination.page <= 1"
                            class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Previous</button>
                        <button @click="fetchHistory(historyPagination.page + 1)"
                            :disabled="historyPagination.page >= historyPagination.pages"
                            class="ml-2 px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Next</button>
                    </div>
                </div>
            </section>

            <!-- Guest Management Section -->
            <section x-show="activeSection === 'guests'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Guest Users
                </h1>
                <div class="mb-4 flex space-x-2">
                    <input type="text" x-model="guestSearchTerm" @input.debounce.500ms="fetchGuests(1)"
                        placeholder="Search guests (ID or IP)..." class="p-2 border rounded w-full md:w-1/3">
                    <button @click="bulkDelete('guests', selectedGuests)" :disabled="!selectedGuests.length"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:opacity-50 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        Delete Selected
                    </button>
                </div>
                <div class="bg-white shadow rounded overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox"
                                        @change="toggleSelectAll('guests', $event.target.checked)"></th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Guest ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    IP Address</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Scan Count</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Last Scan</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Created At</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-if="guests.length === 0 && !loading">
                                <tr>
                                    <td colspan="7" class="text-center py-4">No guests found.</td>
                                </tr>
                            </template>
                            <template x-for="guest in guests" :key="guest._id">
                                <tr>
                                    <td class="px-6 py-4"><input type="checkbox" :value="guest._id"
                                            x-model="selectedGuests"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                        x-text="guest.guestId"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="guest.ipAddress"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="guest.scanCount"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDateTime(guest.lastScan)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDateTime(guest.createdAt)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button @click="confirmDelete('guest', guest._id, guest.guestId)"
                                            class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="guestPagination.pages > 1" class="mt-4 flex justify-between items-center">
                    <span class="text-sm text-gray-700">Page <span x-text="guestPagination.page"></span> of <span
                            x-text="guestPagination.pages"></span> (<span x-text="guestPagination.total"></span>
                        guests)</span>
                    <div>
                        <button @click="fetchGuests(guestPagination.page - 1)" :disabled="guestPagination.page <= 1"
                            class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Previous</button>
                        <button @click="fetchGuests(guestPagination.page + 1)"
                            :disabled="guestPagination.page >= guestPagination.pages"
                            class="ml-2 px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Next</button>
                    </div>
                </div>
            </section>

            <!-- Contact Submissions Section -->
            <section x-show="activeSection === 'contacts'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                    Contact Submissions
                </h1>
                <div class="mb-4 flex space-x-2">
                    <button @click="bulkDelete('contacts', selectedContacts)" :disabled="!selectedContacts.length"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:opacity-50 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        Delete Selected
                    </button>
                </div>
                <div class="bg-white shadow rounded overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox"
                                        @change="toggleSelectAll('contacts', $event.target.checked)"></th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Name</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Email</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Subject</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Message</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Submitted At</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-if="contacts.length === 0 && !loading">
                                <tr>
                                    <td colspan="7" class="text-center py-4">No contacts found.</td>
                                </tr>
                            </template>
                            <template x-for="contact in contacts" :key="contact._id">
                                <tr>
                                    <td class="px-6 py-4"><input type="checkbox" :value="contact._id"
                                            x-model="selectedContacts"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                        x-text="contact.name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="contact.email"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="contact.subject"></td>
                                    <td class="px-6 py-4 whitespace-normal text-sm text-gray-500 max-w-xs truncate"
                                        x-text="contact.message"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                        x-text="formatDateTime(contact.createdAt)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button @click="confirmDelete('contact', contact._id, contact.subject)"
                                            class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="contactPagination.pages > 1" class="mt-4 flex justify-between items-center">
                    <span class="text-sm text-gray-700">Page <span x-text="contactPagination.page"></span> of <span
                            x-text="contactPagination.pages"></span> (<span x-text="contactPagination.total"></span>
                        contacts)</span>
                    <div>
                        <button @click="fetchContacts(contactPagination.page - 1)"
                            :disabled="contactPagination.page <= 1"
                            class="px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Previous</button>
                        <button @click="fetchContacts(contactPagination.page + 1)"
                            :disabled="contactPagination.page >= contactPagination.pages"
                            class="ml-2 px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50">Next</button>
                    </div>
                </div>
            </section>

            <!-- Notification Section -->
            <section x-show="activeSection === 'notifications'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                        </path>
                    </svg>
                    Send Notification
                </h1>
                <div class="bg-white p-6 rounded shadow max-w-lg">
                    <form @submit.prevent="sendNotification">
                        <div class="mb-4">
                            <label for="notification-title"
                                class="block text-sm font-medium text-gray-700">Title</label>
                            <input type="text" id="notification-title" x-model="notificationForm.title" required
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="notification-message"
                                class="block text-sm font-medium text-gray-700">Message</label>
                            <textarea id="notification-message" x-model="notificationForm.message" required rows="4"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="notification-type" class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="notification-type" x-model="notificationForm.type"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="system">System</option>
                                <option value="feature">Feature Update</option>
                                <option value="subscription">Subscription</option>
                                <option value="security">Security</option>
                                <option value="scan">Scan Related</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="notification-user" class="block text-sm font-medium text-gray-700">Target User
                                ID (Optional)</label>
                            <input type="text" id="notification-user" x-model="notificationForm.userId"
                                placeholder="Leave blank to send to all users"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" :disabled="loading"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded disabled:opacity-50 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                            </svg>
                            Send Notification
                        </button>
                    </form>
                </div>
            </section>

            <!-- Analytics Section -->
            <section x-show="activeSection === 'analytics'" x-cloak>
                <h1 class="text-2xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                    Analytics
                </h1>
                <div class="bg-white p-4 rounded shadow mt-4">
                    <h3 class="text-lg font-semibold mb-2">User Growth</h3>
                    <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"
                        x-text="JSON.stringify(adminAnalytics?.userGrowth, null, 2) || 'Loading...'"></pre>
                </div>
                <div class="bg-white p-4 rounded shadow mt-4">
                    <h3 class="text-lg font-semibold mb-2">Subscription Trends</h3>
                    <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"
                        x-text="JSON.stringify(adminAnalytics?.subscriptionTrends, null, 2) || 'Loading...'"></pre>
                </div>
                <!-- Add Chart.js integration here if desired -->
            </section>

            <!-- Generic Modal -->
            <div x-show="showModal" x-cloak class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title"
                role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showModal = false">
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true"></span>
                    <div
                        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div x-show="modalType === 'delete'"
                                    class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                        </path>
                                    </svg>
                                </div>
                                <div x-show="modalType === 'viewUser'"
                                    class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                        </path>
                                    </svg>
                                </div>
                                <div x-show="modalType === 'editUser'"
                                    class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                        </path>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="modalTitle"></h3>
                                    <div class="mt-2">
                                        <p x-show="modalType === 'delete'" class="text-sm text-gray-500"
                                            x-text="modalContent"></p>
                                        <div x-show="modalType === 'viewUser'" class="text-sm text-gray-600 space-y-1">
                                            <p><strong>ID:</strong> <span x-text="modalData._id"></span></p>
                                            <p><strong>Username:</strong> <span x-text="modalData.username"></span></p>
                                            <p><strong>Email:</strong> <span x-text="modalData.email"></span></p>
                                            <p><strong>Full Name:</strong> <span
                                                    x-text="modalData.fullName || 'N/A'"></span></p>
                                            <p><strong>Phone:</strong> <span
                                                    x-text="modalData.phoneNumber || 'N/A'"></span></p>
                                            <p><strong>Role:</strong> <span x-text="modalData.role"></span></p>
                                            <p><strong>Joined:</strong> <span
                                                    x-text="formatDateTime(modalData.createdAt)"></span></p>
                                            <p><strong>Last Login:</strong> <span
                                                    x-text="formatDateTime(modalData.lastLogin) || 'N/A'"></span></p>
                                            <p><strong>Plan:</strong> <span
                                                    x-text="modalData.subscription?.currentPlan || 'free'"></span></p>
                                            <p><strong>Sub Status:</strong> <span
                                                    x-text="modalData.subscription?.status || 'N/A'"></span></p>
                                            <p><strong>Sub Expires:</strong> <span
                                                    x-text="formatDateTime(modalData.subscription?.expiresAt) || 'N/A'"></span>
                                            </p>
                                        </div>
                                        <form x-show="modalType === 'editUser'" @submit.prevent="submitUserEdit">
                                            <input type="hidden" x-model="editUserForm.id">
                                            <div class="mb-2">
                                                <label class="block text-sm font-medium text-gray-700">Full
                                                    Name:</label>
                                                <input type="text" x-model="editUserForm.fullName"
                                                    class="mt-1 block w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500">
                                            </div>
                                            <div class="mb-2">
                                                <label class="block text-sm font-medium text-gray-700">Email:</label>
                                                <input type="email" x-model="editUserForm.email"
                                                    class="mt-1 block w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500">
                                            </div>
                                            <div class="mb-2">
                                                <label class="block text-sm font-medium text-gray-700">Phone
                                                    Number:</label>
                                                <input type="tel" x-model="editUserForm.phoneNumber"
                                                    class="mt-1 block w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500">
                                            </div>
                                            <div class="mb-2">
                                                <label class="block text-sm font-medium text-gray-700">Role:</label>
                                                <select x-model="editUserForm.role"
                                                    class="mt-1 block w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500">
                                                    <option value="user">User</option>
                                                    <option value="admin">Admin</option>
                                                </select>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button x-show="modalType === 'delete'" @click="executeDelete()"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">Delete</button>
                            <button x-show="modalType === 'editUser'" @click="submitUserEdit()"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Save
                                Changes</button>
                            <button @click="showModal = false"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function getTokenFromStorage() {
            const localToken = localStorage.getItem('token');
            if (localToken) return localToken;
            return getCookie('token');
        }

        function adminApp() {
            return {
                activeSection: 'dashboard',
                loading: false,
                errorMessage: '',
                successMessage: '',
                stats: {},
                users: [],
                selectedUsers: [],
                userPagination: { page: 1, pages: 1, total: 0, limit: 10 },
                userSearchTerm: '',
                subscriptions: [],
                selectedSubscriptions: [],
                pendingSubsCount: 0,
                activeSubsCount: 0,
                history: [],
                selectedHistory: [],
                historyPagination: { page: 1, pages: 1, total: 0, limit: 10 },
                historySearchTerm: '',
                guests: [],
                selectedGuests: [],
                guestPagination: { page: 1, pages: 1, total: 0, limit: 10 },
                guestSearchTerm: '',
                contacts: [],
                selectedContacts: [],
                contactPagination: { page: 1, pages: 1, total: 0, limit: 10 },
                notificationForm: { title: '', message: '', type: 'system', userId: '' },
                adminAnalytics: null,
                showModal: false,
                modalType: '',
                modalTitle: '',
                modalContent: '',
                modalData: null,
                itemToDelete: { type: '', id: '', name: '' },
                editUserForm: { id: '', fullName: '', email: '', phoneNumber: '', role: '' },

                init() {
                    console.log("Admin App Initializing...");
                    this.checkAuth().then(isAdmin => {
                        if (isAdmin) this.setActiveSection('dashboard');
                    });
                    window.addEventListener('hashchange', () => {
                        const hash = window.location.hash.substring(1) || 'dashboard';
                        this.setActiveSection(hash);
                    });
                    const initialHash = window.location.hash.substring(1);
                    if (initialHash && ['dashboard', 'users', 'subscriptions', 'history', 'guests', 'contacts', 'notifications', 'analytics'].includes(initialHash)) {
                        this.setActiveSection(initialHash);
                    }
                },

                getToken() {
                    return getTokenFromStorage();
                },

                async checkAuth() {
                    const token = this.getToken();
                    if (!token) {
                        this.redirectToLogin("No token found.");
                        return false;
                    }
                    try {
                        const data = await this.apiRequest('/api/auth/verify', 'GET');
                        if (data.status === 'success' && data.role === 'admin') {
                            console.log("Admin verified.");
                            return true;
                        } else {
                            this.redirectToLogin("Access denied: Not an admin.");
                            return false;
                        }
                    } catch (error) {
                        console.error("Auth check failed:", error);
                        this.redirectToLogin(`Authentication error: ${error.message}`);
                        return false;
                    }
                },

                redirectToLogin(reason = "Session expired or invalid.") {
                    console.warn("Redirecting to login:", reason);
                    this.showError(`Admin access required. ${reason} Redirecting to login.`);
                    localStorage.removeItem('token');
                    document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                },

                logout() {
                    this.apiRequest('/api/auth/logout', 'POST')
                        .then(() => {
                            localStorage.removeItem('token');
                            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                            this.redirectToLogin("Logged out.");
                        })
                        .catch(error => {
                            console.error("Logout failed:", error);
                            this.showError("Logout failed. Please try again.");
                            localStorage.removeItem('token');
                            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                            this.redirectToLogin("Logout error occurred.");
                        });
                },

                async apiRequest(endpoint, method = 'GET', body = null, isFormData = false) {
                    this.loading = true;
                    this.errorMessage = '';
                    const token = this.getToken();
                    if (!token) {
                        this.loading = false;
                        this.redirectToLogin();
                        throw new Error("Authentication token missing.");
                    }
                    const headers = { 'Authorization': `Bearer ${token}` };
                    if (!isFormData && body) headers['Content-Type'] = 'application/json';
                    const options = { method, headers };
                    if (body && method !== 'GET') options.body = isFormData ? body : JSON.stringify(body);
                    try {
                        const response = await fetch(endpoint, options);
                        if (response.status === 401 || response.status === 403) {
                            this.redirectToLogin("Unauthorized or Forbidden.");
                            throw new Error("Unauthorized");
                        }
                        const contentType = response.headers.get('content-type');
                        let data;
                        if (contentType && contentType.includes('application/json')) {
                            data = await response.json();
                        } else if (contentType && contentType.includes('text/csv')) {
                            data = await response.text();
                            const blob = new Blob([data], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = endpoint.split('/').pop() + '.csv';
                            a.click();
                            window.URL.revokeObjectURL(url);
                            this.loading = false;
                            return;
                        } else {
                            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                            this.loading = false;
                            return response;
                        }
                        if (!response.ok) {
                            throw new Error(data.message || `HTTP error! Status: ${response.status}`);
                        }
                        this.loading = false;
                        return data;
                    } catch (error) {
                        this.loading = false;
                        this.showError(`Request failed: ${error.message}`);
                        throw error;
                    }
                },

                setActiveSection(section) {
                    this.activeSection = section;
                    this.selectedUsers = [];
                    this.selectedSubscriptions = [];
                    this.selectedHistory = [];
                    this.selectedGuests = [];
                    this.selectedContacts = [];
                    switch (section) {
                        case 'dashboard':
                            this.fetchDashboardStats();
                            this.fetchSubscriptions();
                            break;
                        case 'users':
                            this.fetchUsers(this.userPagination.page);
                            break;
                        case 'subscriptions':
                            this.fetchSubscriptions();
                            break;
                        case 'history':
                            this.fetchHistory(this.historyPagination.page);
                            break;
                        case 'guests':
                            this.fetchGuests(this.guestPagination.page);
                            break;
                        case 'contacts':
                            this.fetchContacts(this.contactPagination.page);
                            break;
                        case 'analytics':
                            this.fetchAnalytics();
                            break;
                        case 'notifications':
                            // No fetch needed
                            break;
                    }
                },

                async fetchDashboardStats() {
                    try {
                        const data = await this.apiRequest('/api/admin/dashboard-stats');
                        this.stats = {
                            user_count: data.stats.totalUsers,
                            guest_count: data.stats.guestCount,
                            history_count: data.stats.historyCount
                        };
                    } catch (error) {
                        console.error("Failed to fetch dashboard stats:", error);
                    }
                },

                async fetchUsers(page = 1) {
                    try {
                        const query = new URLSearchParams({
                            page,
                            limit: this.userPagination.limit,
                            search: this.userSearchTerm
                        }).toString();
                        const data = await this.apiRequest(`/api/admin/users?${query}`);
                        this.users = data.users;
                        this.userPagination = data.pagination;
                    } catch (error) {
                        console.error("Failed to fetch users:", error);
                    }
                },

                async fetchSubscriptions() {
                    try {
                        const data = await this.apiRequest('/api/admin/subscriptions');
                        this.subscriptions = data.subscriptions || [];
                        this.pendingSubsCount = this.subscriptions.filter(sub => sub.status === 'pending').length;
                        this.activeSubsCount = this.subscriptions.filter(sub => sub.status === 'active').length;
                    } catch (error) {
                        console.error("Failed to fetch subscriptions:", error);
                    }
                },

                async fetchHistory(page = 1) {
                    try {
                        const query = new URLSearchParams({
                            page,
                            limit: this.historyPagination.limit,
                            search: this.historySearchTerm
                        }).toString();
                        const data = await this.apiRequest(`/api/admin/history?${query}`);
                        this.history = data.history;
                        this.historyPagination = data.pagination;
                    } catch (error) {
                        console.error("Failed to fetch history:", error);
                    }
                },

                async fetchGuests(page = 1) {
                    try {
                        const query = new URLSearchParams({
                            page,
                            limit: this.guestPagination.limit,
                            search: this.guestSearchTerm
                        }).toString();
                        const data = await this.apiRequest(`/api/admin/guests?${query}`);
                        this.guests = data.guests;
                        this.guestPagination = data.pagination;
                    } catch (error) {
                        console.error("Failed to fetch guests:", error);
                    }
                },

                async fetchContacts(page = 1) {
                    try {
                        const data = await this.apiRequest(`/api/admin/contacts?page=${page}&limit=${this.contactPagination.limit}`);
                        this.contacts = data.contacts;
                        this.contactPagination = data.pagination;
                    } catch (error) {
                        console.error("Failed to fetch contacts:", error);
                    }
                },

                async fetchAnalytics() {
                    try {
                        const userGrowth = await this.apiRequest('/api/admin/analytics/user-growth');
                        const subscriptionTrends = await this.apiRequest('/api/admin/analytics/subscription-trends');
                        this.adminAnalytics = {
                            userGrowth: userGrowth.data,
                            subscriptionTrends: subscriptionTrends.data
                        };
                    } catch (error) {
                        console.error("Failed to fetch analytics:", error);
                    }
                },

                async sendNotification() {
                    try {
                        const response = await this.apiRequest('/api/admin/notifications', 'POST', this.notificationForm);
                        this.showSuccess(response.message || 'Notification sent successfully!');
                        this.notificationForm = { title: '', message: '', type: 'system', userId: '' };
                    } catch (error) {
                        console.error("Failed to send notification:", error);
                    }
                },

                async processSubscription(subId, action) {
                    try {
                        const response = await this.apiRequest(`/api/admin/subscriptions/${subId}/${action}`, 'PUT');
                        this.showSuccess(response.message || `Subscription ${action}ed successfully!`);
                        this.fetchSubscriptions();
                    } catch (error) {
                        console.error(`Failed to ${action} subscription:`, error);
                    }
                },

                async expireSubscription(subId) {
                    try {
                        const response = await this.apiRequest(`/api/admin/subscriptions/${subId}/expire`, 'PUT');
                        this.showSuccess(response.message || 'Subscription expired successfully!');
                        this.fetchSubscriptions();
                    } catch (error) {
                        console.error("Failed to expire subscription:", error);
                    }
                },

                async bulkDelete(type, ids) {
                    if (!ids.length) return;
                    if (!confirm(`Are you sure you want to delete ${ids.length} ${type}? This action cannot be undone.`)) return;
                    try {
                        const response = await this.apiRequest(`/api/admin/${type}/bulk`, 'DELETE', { [`${type}Ids`]: ids });
                        this.showSuccess(response.message);
                        this[`fetch${type.charAt(0).toUpperCase() + type.slice(1)}`]();
                        this[`selected${type.charAt(0).toUpperCase() + type.slice(1)}`] = [];
                    } catch (error) {
                        console.error(`Failed to bulk delete ${type}:`, error);
                    }
                },

                toggleSelectAll(type, checked) {
                    const key = `selected${type.charAt(0).toUpperCase() + type.slice(1)}`;
                    this[key] = checked ? this[type].map(item => item._id) : [];
                },

                confirmDelete(type, id, name = '') {
                    this.itemToDelete = { type, id, name };
                    this.modalType = 'delete';
                    this.modalTitle = `Confirm Deletion`;
                    this.modalContent = `Are you sure you want to delete ${type} "${name || id}"? This action cannot be undone.`;
                    this.showModal = true;
                },

                async executeDelete() {
                    try {
                        const { type, id } = this.itemToDelete;
                        const response = await this.apiRequest(`/api/admin/${type}/${id}`, 'DELETE');
                        this.showSuccess(response.message || `${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully!`);
                        this.showModal = false;
                        this[`fetch${type.charAt(0).toUpperCase() + type.slice(1)}`]();
                    } catch (error) {
                        console.error("Deletion failed:", error);
                        this.showModal = false;
                    }
                },

                async viewUserDetails(userId) {
                    try {
                        const data = await this.apiRequest(`/api/admin/users/${userId}`);
                        this.modalData = data.user;
                        this.modalType = 'viewUser';
                        this.modalTitle = `User Details: ${this.modalData.username}`;
                        this.showModal = true;
                    } catch (error) {
                        console.error("Failed to fetch user details:", error);
                    }
                },

                editUser(user) {
                    this.editUserForm = {
                        id: user._id,
                        fullName: user.fullName || '',
                        email: user.email,
                        phoneNumber: user.phoneNumber || '',
                        role: user.role
                    };
                    this.modalType = 'editUser';
                    this.modalTitle = `Edit User: ${user.username}`;
                    this.showModal = true;
                },

                async submitUserEdit() {
                    try {
                        const response = await this.apiRequest(`/api/admin/users/${this.editUserForm.id}`, 'PUT', this.editUserForm);
                        this.showSuccess(response.message || 'User updated successfully!');
                        this.showModal = false;
                        this.fetchUsers(this.userPagination.page);
                    } catch (error) {
                        console.error("Failed to update user:", error);
                    }
                },

                showError(message) {
                    this.errorMessage = message;
                },

                showSuccess(message) {
                    this.successMessage = message;
                    setTimeout(() => this.successMessage = '', 3000);
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    return new Date(dateString).toLocaleDateString(undefined, options);
                },

                formatDateTime(dateString) {
                    if (!dateString) return 'N/A';
                    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                    return new Date(dateString).toLocaleDateString(undefined, options);
                }
            }
        }
    </script>

</body>

</html>